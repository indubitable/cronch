@model cronch.Models.ViewModels.JobViewModel

<div id="job-form-container" class="container text-start px-5">
    <div asp-validation-summary="All" class="rounded border border-2 border-danger"></div>
    <form method="post" hx-boost="true" hx-select="#job-form-container" hx-target="#job-form-container" hx-swap="outerHTML" hx-disinherit="hx-select" hx-ext="loading-states">

        <h5 class="border-bottom pb-2 mb-3">Schedule</h5>

        <div class="mb-3">
            <label asp-for="Name" class="form-label"></label>
            <input asp-for="Name" class="form-control" />
            <span asp-validation-for="Name" class="text-danger"></span>
        </div>

        <div class="mb-3">
            <div class="form-check form-switch">
                <input asp-for="Enabled" type="checkbox" class="form-check-input" autocomplete="off" />
                <label asp-for="Enabled" class="form-check-label"></label>
            </div>
            <div class="form-text">When disabled, the job will not run on its schedule.</div>
        </div>

        <div class="row gx-5 mb-3">
            <div class="col">
                <label asp-for="CronSchedule" class="form-label"></label>
                <input asp-for="CronSchedule" class="form-control cron-schedule-input"
                       hx-get="?handler=CronPreview" hx-trigger="input changed delay:400ms"
                       hx-target="#cron-preview" hx-swap="innerHTML" />
                <div id="cron-preview" class="form-text">@(Model?.GetValidatedCronDescription())</div>
                <span asp-validation-for="CronSchedule" class="text-danger"></span>
            </div>
            <div class="col">
                <div class="shadow p-3 bg-body-tertiary rounded">
                    <a target="_blank" href="https://github.com/HangfireIO/Cronos#cron-format">A six-part (with seconds) cron expression</a>
                    <div class="small text-muted mt-3 mb-1">Quick choices</div>
                    <div class="d-flex flex-wrap gap-1">
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setCronSchedule('*/30 * * * * *')">Every 30 seconds</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setCronSchedule('0 * * * * *')">Every minute</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setCronSchedule('0 0 * * * *')">Every hour</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setCronSchedule('0 0 0 * * MON-FRI')">At midnight Monday–Friday</button>
                    </div>
                </div>
            </div>
        </div>
        <script>
            function setCronSchedule(val) {
                var input = document.querySelector('.cron-schedule-input');
                input.value = val;
                htmx.trigger(input, 'input');
            }
        </script>

        <hr class="my-4" />

        <h5 class="border-bottom pb-2 mb-3">Script &amp; Executor</h5>

        <div class="row gx-5 mb-4">
            <div class="col">
                <label asp-for="Script" class="form-label"></label>
                <input type="hidden" asp-for="Script" id="script-hidden" />
                <pre id="script-editor" class="script-editor script-editor-loading" data-script-editor="script-hidden">@(Model?.Script)</pre>
                <span asp-validation-for="Script" class="text-danger"></span>
            </div>
            <div class="col">
                <div class="shadow p-3 bg-body-tertiary rounded" style="position: sticky; top: 1rem;">
                    <strong>Environment variables</strong>
                    <ul class="mt-2 mb-3">
                        <li><code>CRONCH_JOB_ID</code> – job ID</li>
                        <li><code>CRONCH_JOB_NAME</code> – job name</li>
                        <li><code>CRONCH_EXECUTION_ID</code> – execution ID</li>
                    </ul>
                    <hr />
                    <small class="text-muted">To force syntax highlighting to a specific language, add a comment in the form <code>[[[CRONCH:syntax:javascript]]]</code>. See available <a target="_blank" href="https://github.com/indubitable/cronch/tree/main/cronch/wwwroot/lib/ace"><code>mode-*.js</code></a> files.</small>
                </div>
            </div>
        </div>

        <div class="row gx-5 mb-4">
            <div class="col">
                <label asp-for="Executor" class="form-label"></label>
                <input asp-for="Executor" class="form-control executor-input" />
                <span asp-validation-for="Executor" class="text-danger"></span>

                <label asp-for="ExecutorArgs" class="form-label mt-3"></label>
                <input asp-for="ExecutorArgs" class="form-control executor-args-input" />
                <span asp-validation-for="ExecutorArgs" class="text-danger"></span>
            </div>
            <div class="col">
                <div class="shadow p-3 bg-body-tertiary rounded">
                    <partial name="_ExecutorFormHelpPartial" />
                </div>
            </div>
        </div>

        <div class="row gx-5 mb-3">
            <div class="col">
                <label asp-for="ScriptFilePathname" class="form-label"></label>
                <input asp-for="ScriptFilePathname" class="form-control" />
                <span asp-validation-for="ScriptFilePathname" class="text-danger"></span>
            </div>
            <div class="col">
                <div class="shadow p-3 bg-body-tertiary rounded">
                    Optional — if specified, this filename is used for the script file instead of a randomly generated name. Useful when a specific extension is required (e.g., <code>.bat</code> on Windows).
                    <br /><br />
                    <span class="text-danger fw-semibold">Parallelism risk:</span> the same filename is reused on every execution. If two executions run simultaneously, one may overwrite the other's script file mid-run. Use <code>{0}</code> in the filename to substitute a random component and mitigate this.
                    <br /><br />
                    If left empty, a randomly generated filename is created in the default script file location (configured in Settings).
                </div>
            </div>
        </div>

        <hr class="my-4" />

        <h5 class="border-bottom pb-2 mb-3">Limits</h5>

        <div class="mb-3">
            <label asp-for="TimeLimitSecs" class="form-label"></label>
            <input asp-for="TimeLimitSecs" class="form-control" style="max-width: 10rem;" />
            <div class="form-text">Leave empty for no limit. Set to 0 to kill the job immediately after it starts.</div>
            <span asp-validation-for="TimeLimitSecs" class="text-danger"></span>
        </div>

        <div class="mb-3">
            <label asp-for="Parallelism" class="form-label"></label>
            <input asp-for="Parallelism" class="form-control" style="max-width: 10rem;" />
            <div class="form-text">Leave empty for no limit. Set to 1 to allow only one execution at a time.</div>
            <span asp-validation-for="Parallelism" class="text-danger"></span>
        </div>

        <div class="mb-3">
            <label asp-for="MarkParallelSkipAs" class="form-label"></label>
            <select asp-for="MarkParallelSkipAs" asp-items="cronch.Models.ViewModels.JobViewModel.ParallelSkipProcessingOptions" class="form-select"></select>
            <div class="form-text">How to record executions that are skipped due to the parallelism limit.</div>
        </div>

        <hr class="my-4" />

        <h5 class="border-bottom pb-2 mb-3">Output</h5>

        <div class="row gx-5 mb-3">
            <div class="col">
                <div class="mb-3">
                    <label asp-for="Keywords" class="form-label"></label>
                    <input asp-for="Keywords" class="form-control" />
                    <div class="form-text">Comma-separated. Used by keyword-based processing rules below.</div>
                    <span asp-validation-for="Keywords" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="StdOutProcessing" class="form-label"></label>
                    <select asp-for="StdOutProcessing" asp-items="cronch.Models.ViewModels.JobViewModel.OutputProcessingOptions" class="form-select"></select>
                </div>

                <div class="mb-3">
                    <label asp-for="StdErrProcessing" class="form-label"></label>
                    <select asp-for="StdErrProcessing" asp-items="cronch.Models.ViewModels.JobViewModel.OutputProcessingOptions" class="form-select"></select>
                </div>
            </div>
            <div class="col">
                <div class="shadow p-3 bg-body-tertiary rounded">
                    Controls how job output affects the execution status.
                    <ul class="mt-2 mb-0">
                        <li><strong>None</strong> — output is captured but does not affect status.</li>
                        <li><strong>Any output</strong> — any content on the stream triggers the chosen status.</li>
                        <li><strong>Keyword match</strong> — only triggers if a keyword from the Keywords field appears in the output.</li>
                    </ul>
                </div>
            </div>
        </div>

        <button type="submit" class="btn btn-primary mb-4" data-loading-disable>
            <span class="spinner-border spinner-border-sm me-1" data-loading style="display:none;" role="status" aria-hidden="true"></span>Save
        </button>
        <a href="/Manage" class="btn btn-secondary mb-4 ms-2" hx-boost="false">Cancel</a>
    </form>
</div>
